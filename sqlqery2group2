--5 Correlated and non-correlated subqueries for customer insights.
--last activity Correlated Subquery for renter
DECLARE @customer_id INT = 3;

select top 1
    b.id AS BookingID,
    b.createdate AS LastBookingDate,
    r.type AS UnitType,
    p.status AS PaymentStatus
from bookings b 
inner join rentable_units r
on r.id=b.unit_id
left join
payments p
on p.booking_id=b.id
where b.user_id=@customer_id
order by b.createdate desc

-- each unit statstics for owner correlated subquery
DECLARE @owner_id INT = 4;  

SELECT 
    r.id AS UnitID,
    r.type AS UnitType,
    
    -- bookings number for unit
    (SELECT COUNT(*) 
     FROM bookings b
     WHERE b.unit_id = r.id) AS TotalBookings,
     
    -- last booking for unit
    (SELECT TOP 1 b.createdate
     FROM bookings b
     WHERE b.unit_id = r.id
     ORDER BY b.createdate DESC) AS LastBookingDate,
     
    -- last renter for the unit
    (SELECT TOP 1 u.fname
     FROM bookings b
     INNER JOIN users u
        ON b.user_id = u.id
     WHERE b.unit_id = r.id
     ORDER BY b.createdate DESC) AS LastCustomerName,
     
    -- TotalRevenue for each unit
    (SELECT ISNULL(SUM(p.amount), 0)
     FROM bookings b
     LEFT JOIN payments p
        ON b.id = p.booking_id
     WHERE b.unit_id = r.id
       AND p.status = 'paid') AS TotalRevenue
     
FROM rentable_units r inner join apartments a
on r.apartment_id=a.anum
WHERE a.user_id = @owner_id 
